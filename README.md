# Transaction Service

## Описание

Этот проект представляет собой сервис для обработки транзакций с возможностью расчета расходов в долларах США (USD) на основе текущих или последних доступных курсов валют. В частности, поддерживаются курсы KZT/USD и RUB/USD. Курсы валют загружаются ежедневно с использованием внешнего API (например, Fixer API) и сохраняются в базе данных PostgreSQL для дальнейшего использования в расчетах. Flyway для миграции баз данных.
## Стек технологий
- Java 17
- Spring Boot 3.2.0
- PostgreSQL
- JPA (Hibernate)
- Flyway (for database migrations)
- Fixer API (for currency exchange rates)
- Docker and Docker Compose (for containerization)
- @EnableScheduling (for periodic tasks)

  
## Запуск сервиса

### 1. Установка необходимых инструментов
Перед тем как запустить сервис, убедитесь, что у вас установлены следующие инструменты:

- [Docker](https://docs.docker.com/get-started/get-docker/)
- [Docker Compose](https://docs.docker.com/compose/install/)

### 2. Запуск с использованием Docker Compose

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/lesbaydias/transactions-api-converter.git
   cd transactions-api-converter
   
3. Соберите и запустите контейнеры с помощью Docker Compose:
   ```bash
   docker compose up
  
  Эта команда:
  - Сначала собирает образ вашего Java приложения.
  - Запускает сервис transaction-service и базу данных PostgreSQL

## API Endpoints
### API транзакций
Создайте транзакцию: POST http://localhost:8080/api/transactions/create

В разделе Postman "Body"

```bash
{
    "accountFrom": 1111111111,
    "accountTo": 2222222222,
    "currencyShortName": "KZT",
    "sum": 150000.00,
    "expenseCategoryType": "PRODUCT"
}
```


### ОБЯЗАТЕЛЬНО:
Если текущая дата выходная дата, то сервер должен отправить последнюю актуальную информацию о валюте. А если таковой информации не имеется то должен срабатывать Exception.


## API-клиент
1. Получить транзакции, превышающие лимит: GET http://localhost:8080/api/limits/exceeded

Возвращает транзакции, превысившие установленный месячный лимит.

2.Установить новый месячный лимит: POST http://localhost:8080/api/limits/set
```bash
{
    "limitSum": 1000.00
}
```
Устанавливает новый ежемесячный лимит расходов.

## Схема базы данных
Приложение использует PostgreSQL и включает следующие таблицы:

- лимиты: сохраняет ежемесячные лимиты расходов с датой их установки.
- транзакции: хранит все транзакции, включая флаг (limit_exceeded), указывающий, превысила ли транзакция месячный лимит.
- currency_rate: кэширует обменные курсы (KZT/USD, RUB/USD), чтобы избежать частых вызовов API.

#### Flyway используется для управления миграцией баз данных.

## Docker and Deployment
### Docker
Для контейнеризации приложения предоставляется Dockerfile.

1. Сборка образа Docker:
```bash
docker build -t transactionservice .
```
2. Запустите Docker-контейнер:
```bash
docker run -p 8080:8080 transactionservice
```

### Docker Compose
Файл docker-compose.yml предоставляется для запуска приложения вместе с PostgreSQL.

1. Запустите службы с помощью Docker Compose:
```bash
docker-compose up --build
```

## Планирование и сброс лимитов
Микросервис использует аннотацию @EnableScheduling Spring для автоматического сброса месячного лимита 1-го числа каждого месяца.

## Интеграция внешнего API
Этот сервис использует API Fixer для получения обменных курсов пар KZT/USD и RUB/USD. Курсы сохраняются в базе данных и используются для конвертации валют.

## Объяснение решений
    - Выбор монолитной структуры: Мы решили использовать монолитную архитектуру для упрощения разработки и деплоя на начальных этапах проекта. Это упрощает взаимодействие между компонентами и позволяет быстрее разрабатывать и тестировать функционал.
    
    - Добавление таблицы для курсов валют: Мы создали третью таблицу для хранения курсов валют, чтобы запрашивать и хранить дневные курсы валютных пар KZT/USD и RUB/USD. Это позволяет минимизировать обращения к внешним API и использовать локальные данные при расчете.
    
    - Планировщик задач: Использование аннотации @Scheduled для сброса месячного лимита позволяет автоматически обновлять лимиты расходов первого числа каждого месяца.
    
    - Код для получения курсов валют: Мы реализовали метод getCurrencyRate, который проверяет наличие курса на текущий день, запрашивает его с API при необходимости и использует последний доступный курс, если данные недоступны.


   
